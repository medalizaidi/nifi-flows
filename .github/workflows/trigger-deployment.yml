name: Trigger NiFi Deployment

on:
  push:
    branches:
      - main

jobs:
  trigger-circleci:
    name: Trigger CircleCI Pipeline
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout flows
        uses: actions/checkout@v4
      
      - name: Get latest commit info
        id: commit_info
        run: |
          {
            echo "message<<EOF"
            git log -1 --pretty=%B | head -1
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      
      - name: Display trigger info
        run: |
          echo "üîî Flow Update Detected"
          echo "Commit: ${{ steps.commit_info.outputs.sha }}"
          echo "Message: ${{ steps.commit_info.outputs.message }}"
          echo "Author: ${{ steps.commit_info.outputs.author }}"
      
      - name: Trigger CircleCI deployment
        run: |
          echo "Triggering CircleCI pipeline..."
          
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Circle-Token: ${{ secrets.CIRCLECI_TOKEN }}" \
            -H "Content-Type: application/json" \
            https://circleci.com/api/v2/project/github/medalizaidi/nifi/pipeline \
            -d '{
              "branch": "main",
              "parameters": {
                "triggered_by": "flow_update",
                "flow_commit": "${{ steps.commit_info.outputs.sha }}",
                "flow_message": "${{ steps.commit_info.outputs.message }}",
                "flow_author": "${{ steps.commit_info.outputs.author }}"
              }
            }')
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ CircleCI pipeline triggered successfully"
            echo "View at: https://app.circleci.com/pipelines/github/medalizaidi/nifi"
          else
            echo "‚ùå Failed to trigger CircleCI pipeline"
            echo "Check your CIRCLECI_TOKEN secret"
            exit 1
          fi
