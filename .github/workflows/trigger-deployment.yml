name: Trigger NiFi Deployment

on:
  push:
    branches:
      - main

jobs:
  trigger-circleci-via-commit:
    name: Trigger CircleCI via Commit
    runs-on: ubuntu-latest
    
    steps:
      - name: Get flow commit info
        id: flow_info
        uses: actions/checkout@v4
        
      - name: Extract commit details
        id: commit_details
        run: |
          # Get the full commit message (not just first line)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_EMAIL=$(git log -1 --pretty=%ae)
          COMMIT_SHA=$(git rev-parse HEAD)
          
          # Save to output
          {
            echo "message<<EOF"
            echo "$COMMIT_MSG"
            echo "EOF"
          } >> $GITHUB_OUTPUT
          
          echo "author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
          echo "email=$COMMIT_EMAIL" >> $GITHUB_OUTPUT
          echo "sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          
          echo "Flow commit details:"
          echo "SHA: $COMMIT_SHA"
          echo "Author: $COMMIT_AUTHOR <$COMMIT_EMAIL>"
          echo "Message: $COMMIT_MSG"
      
      - name: Checkout nifi repository
        uses: actions/checkout@v4
        with:
          repository: medalizaidi/nifi
          token: ${{ secrets.NIFI_REPO_PAT }}
          path: nifi-repo
      
      - name: Trigger CircleCI with same commit message
        run: |
          cd nifi-repo
          
          # Create/update trigger file with flow info
          mkdir -p .circleci
          cat > .circleci/flow-trigger.json << 'TRIGGER_EOF'
          {
            "flow_commit": "${{ steps.commit_details.outputs.sha }}",
            "flow_author": "${{ steps.commit_details.outputs.author }}",
            "flow_email": "${{ steps.commit_details.outputs.email }}",
            "triggered_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "triggered_from": "nifi-flows repository"
          }
          TRIGGER_EOF
          
          # Configure git with flow author info
          git config user.name "${{ steps.commit_details.outputs.author }}"
          git config user.email "${{ steps.commit_details.outputs.email }}"
          
          # Stage changes
          git add .circleci/flow-trigger.json
          
          # Commit with the SAME message as the flow commit
          git commit -m "${{ steps.commit_details.outputs.message }}" || {
            echo "No changes to commit (trigger file unchanged)"
            exit 0
          }
          
          # Push to trigger CircleCI
          git push origin main
          
          echo ""
          echo "âœ… Triggered CircleCI deployment with commit:"
          echo "   Message: ${{ steps.commit_details.outputs.message }}"
          echo "   Author: ${{ steps.commit_details.outputs.author }}"
          echo ""
          echo "View pipeline at:"
          echo "https://app.circleci.com/pipelines/circleci/NvYUyvaFTwZRZ7JJk3ccvX/LXt2U6FPPvWG8CTRUkbzpo"